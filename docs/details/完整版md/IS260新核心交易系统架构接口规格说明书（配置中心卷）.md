<center><font size=7>IS260 新核心交易系统架构接口规格说明书（配置中心卷）v4.0</font></center>

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1.接口概述](#1接口概述)
  - [1.1 交互方示意图](#11-交互方示意图)
  - [1.2 接口交互对象和数据流向](#12-接口交互对象和数据流向)
- [2.名词解释](#2名词解释)
- [3.参考文档](#3参考文档)
- [4.接口规格](#4接口规格)
  - [4.1 API接口](#41-api接口)
    - [4.1.1.数据结构](#411数据结构)
      - [4.1.1.1 CfgReq](#4111-cfgreq)
      - [4.1.1.2 AnyFile](#4112-anyfile)
      - [4.1.1.3 Target字段和接口、功能实现的对照表](#4113-target字段和接口功能实现的对照表)
      - [4.1.1.4 Action字段和接口、功能实现的对照表](#4114-action字段和接口功能实现的对照表)
      - [4.1.1.5 Type字段和接口、功能实现的对照表](#4115-type字段和接口功能实现的对照表)
      - [4.1.1.6 ArgRange字段](#4116-argrange字段)
      - [4.1.1.7 CfgResp](#4117-cfgresp)
      - [4.1.1.8 Version](#4118-version)
    - [4.1.2.接口设计](#412接口设计)
      - [4.1.2.1 GET](#4121-get)
      - [4.1.2.2 PUT](#4122-put)
      - [4.1.2.3 DELETE](#4123-delete)
      - [4.1.2.4 COMMIT](#4124-commit)
      - [4.1.2.5 GetLatestConfigByEnvNum](#4125-getlatestconfigbyenvnum)
  - [4.2 配置接口](#42-配置接口)
  - [4.3 消息接口](#43-消息接口)
  - [4.4 参考数据接口](#44-参考数据接口)
  - [4.5 监控指标接口](#45-监控指标接口)
  - [4.6 人机接口](#46-人机接口)
- [5.接口使用说明](#5接口使用说明)

<!-- /code_chunk_output -->

# 1.接口概述

## 1.1 交互方示意图

![alt](../../images/概设/交互方4.0.svg)

## 1.2 接口交互对象和数据流向

配置中心服务端的接口包括GET、PUT、COMMIT、DELETE，其

|接口名称|交互对象|数据流向|
|:---:|:----:|:-----:|
|GET|配置中心前端，自动化部署系统|流出配置中心服务端|
|PUT|配置中心前端，自动化部署系统|流入配置中心服务端|
|COMMIT|配置中心前端，自动化部署系统|流入配置中心服务端|
|DELETE|配置中心前端，自动化部署系统|流入配置中心服务端|

# 2.名词解释

参考FS138 新核心交易系统架构需求功能规格说明书（配置中心卷）

# 3.参考文档

FS138 新核心交易系统架构需求功能规格说明书（配置中心卷） MAL107 新核心交易系统架构用户手册（配置中心卷） TD107 新核心交易系统架构总体设计文档（配置中心卷）

# 4.接口规格

## 4.1 API接口

### 4.1.1.数据结构

配置中心的所有接口使用统一的请求结构体CfgReq，以及统一的返回结构体CfgResp，详情如下

#### 4.1.1.1 CfgReq

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :--------------------------: |
| UserName |    string     | 当前操作者的用户名 |
|  Target   | string[] |   指令字符串，用于区分要获取的目标的类型   |
| Action | string | 指令字符串，用于描述修改动作 |
| EnvNum | string | 环境号 |
| File | AnyFile | 用于存放要提交的文件 |
| Version | string | 目标版本号 |
| Scheme | string | 目标配置方案 |
| Type | string | 目标信息类型 |
| Platform | string | 目标平台 |
| NodeType | string | 目标节点类型 |
| Set | string | 目标集群 |
| ArgRange | ArgRange | 输入ip、port范围 |

#### 4.1.1.2 AnyFile

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :--------------------------: |
| FileName |    string     | 文件名 |
|  Content   | byte[] |   文件内容   |

#### 4.1.1.3 Target字段和接口、功能实现的对照表

Target字段主要用于确定要获取的资源种类，其类型为字符串，具备良好的可扩展性。

下表列出了各个功能点中Target关键字应当如何设置：

|     实现功能    |      接口      |      Target    | 说明 |
| :------------: | :-----------: | :-------------: | :-------------: |
| 获取生成的所有配置文件 |      GET       | "config" |  |
| 获取基础设施信息文件 |      GET       | "infra" |  |
| 获取所有版本号 |      GET       | "version" |   |
| 获取原始数据 |      GET       | "raw" |   |
| 获取用户缓存的数据 | GET | "cache" |  |
|  缓存配置数据   |      PUT       |  "raw"  | 目标版本号放在Version字段 |
|  提交基础设施信息文件   |      COMMIT       |  "infra"  |  |
|  提交用户缓存的数据   |      COMMIT       |  "raw"  |  |

#### 4.1.1.4 Action字段和接口、功能实现的对照表

Action字段主要用于限定更新范围，其类型为字符串。

下表列出了各个功能点中Action关键字应当如何设置：

|     实现功能    |      接口      |      Action     | 说明 |
| :------------: | :-----------: | :-------------: | :-------------: |
|  缓存配置数据   |      PUT       |  "ResetAtRoot"  |  在版本范围内全量更新，必须上传符合格式要求的配置数据包，必须配合其他请求参数  |
|  缓存配置数据   |      PUT       |  "ResetAtLeaf"  |  在其他参数限定的范围内全量更新  |
|  缓存配置数据   |      PUT       |  "AddAndReplaceAtLeaf"  |  在其他参数限定的范围内增量更新(允许文件重名，重名即覆盖原文件)  |
| 缓存配置数据 | PUT | "AddButNoReplaceAtLeaf" | 在其他参数限定的范围内增量更新(重名时不覆盖原文件) |

#### 4.1.1.5 Type字段和接口、功能实现的对照表

Type字段用于指定树状结构中的一层，但具有特殊限制，其用法如下：

|     实现功能    |      接口      |      Type     | 说明 |
| :------------: | :-----------: | :-------------: | :-------------: |
|  提交配置数据   |      PUT       |  "deployment"  | 更新部署信息 |
|  提交配置数据   |      PUT       |  "service"  |  更新服务信息  |
|  提交配置数据   |      PUT       |  "template"  |  更新配置模板  |
| 获取原始数据 |      GET       | "deployment" | 获取部署信息 |
| 获取原始数据 |      GET       | "service" | 获取服务信息 |
| 获取原始数据 |      GET       | "template" | 获取配置模板 |

#### 4.1.1.6 ArgRange字段

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :--------------------------: |
| TopicIp | []string  | 用于生成组播地址的Ip范围 |
| TopicPort | []string |  用于生成组播地址的端口范围  |

#### 4.1.1.7 CfgResp

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :--------------------------: |
| status | string | "ok"或执行过程中的错误日志 |
| Versions | Version[] | 版本号数组 |
| File | AnyFile | 文件数据 |

#### 4.1.1.8 Version

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :--------------------------: |
| Name | string | 标准三段式版本号 |
| User | string | 提交该版本号的用户 |
| Time | timestamp | 提交时间的13位时间戳 |

### 4.1.2.接口设计

#### 4.1.2.1 GET

GET接口用于让各个交互方能从配置中心获取文件，包括基础设施信息文件、上传的配置数据包、截至目前的所有历史版本号、用户缓存和配置中心生成的配置结果。

接口原型:

```go
GET(req CfgReq) returns (resp CfgResp)
```

#### 4.1.2.2 PUT

PUT接口用于实现让用户缓存本地的配置包到配置中心服务端，缓存时不对配置文件包的合法性进行校验

接口原型:

```go
PUT(req CfgReq) returns (resp CfgResp)
```

#### 4.1.2.3 DELETE

DELETE接口

DELETE接口用于删除用户在配置中心服务端缓存的配置信息

接口原型:

```go
DELETE(req CfgReq) returns (resp CfgResp)
```

#### 4.1.2.4 COMMIT

COMMIT接口用于提交基础设施信息或者配置文件包信息

接口原型：

```go
COMMIT(req CfgReq) returns (resp CfgResp)
```

#### 4.1.2.5 GetLatestConfigByEnvNum

GetLatestConfigByEnvNum接口用于让外部应用通过环境号获取最新配置

接口原型：

```go
GetLatestConfigByEnvNum(EnvNum string) returns (file AnyFile)
```

## 4.2 配置接口

无

## 4.3 消息接口

无

## 4.4 参考数据接口

无

## 4.5 监控指标接口

暂无

## 4.6 人机接口

参考MAL107 新核心交易系统架构用户手册（配置中心卷）第三章 使用配置中心

# 5.接口使用说明

参考MAL107 新核心交易系统架构用户手册（配置中心卷）第三章 使用配置中心、TD107 新核心交易系统架构总体设计文档（配置中心卷）第八章 接口设计
