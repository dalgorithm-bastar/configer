[toc]

# 修订记录

## Config3.3.1 修订记录

| 序号 | 修订日期   | 修订人 | 审核人 | 修订来源                 | 修订内容概述     |
| ---- | ---------- | ------ | ------ | ------------------------ | ---------------- |
| 1    | 2022/10/11 | 陈清睿 | 韩大伟 | WBS-1159配置中心开发需求 | 增加ezei相关需求 |

## Config4.0 修订记录

| 序号 | 修订日期   | 修订人 | 审核人 | 修订来源                 | 修订内容概述             |
| ---- | ---------- | ------ | ------ | ------------------------ | ------------------------ |
| 1    | 2022/08/02 | 陈清睿 | 林琨   | WBS-1159配置中心开发需求 | 编写配置生成工具接口文档 |

# 接口概述

## 交互方示意图

![交互方示意图](images/需规/交互方1.2.svg)

## 接口交互对象和数据流向

配置中心服务端的接口包括GET、PUT、COMMIT、DELETE，其

|        接口名称         |           交互对象           |      数据流向      |
| :---------------------: | :--------------------------: | :----------------: |
|           GET           | 配置中心前端，自动化部署系统 | 流出配置中心服务端 |
|           PUT           | 配置中心前端，自动化部署系统 | 流入配置中心服务端 |
|         COMMIT          | 配置中心前端，自动化部署系统 | 流入配置中心服务端 |
|         DELETE          | 配置中心前端，自动化部署系统 | 流入配置中心服务端 |
| GetLatestConfigByEnvNum | 配置中心前端，自动化部署系统 | 流出配置中心服务端 |

# 名词解释

参考《FS138新核心交易系统架构需求功能规格说明书（配置中心卷）》

# 参考文档

《FS138新核心交易系统架构需求功能规格说明书（配置中心卷）》
《MAL107新核心交易系统架构用户手册（配置中心卷）》
《TD107新核心交易系统架构总体设计文档（配置中心卷）》

# 接口规格

## API接口

### 数据结构

配置中心的的GET、PUT、DELETE、COMMIT接口使用统一的请求结构体CfgReq，以及统一的返回结构体CfgResp，详情如下

#### CfgReq

|   变量   |   类型   |                  说明                  |
| :------: | :------: | :------------------------------------: |
| UserName |  string  |           当前操作者的用户名           |
|  Target  | string[] | 指令字符串，用于区分要获取的目标的类型 |
|  Action  |  string  |      指令字符串，用于描述修改动作      |
|  EnvNum  |  string  |                 环境号                 |
|   File   | AnyFile  |          用于存放要提交的文件          |
| Version  |  string  |               目标版本号               |
|  Scheme  |  string  |              目标配置方案              |
|   Type   |  string  |              目标信息类型              |
| Platform |  string  |                目标平台                |
| NodeType |  string  |              目标节点类型              |
|   Set    |  string  |                目标集群                |
| ArgRange | ArgRange |            输入ip、port范围            |

#### AnyFile

|   变量   |  类型  |   说明   |
| :------: | :----: | :------: |
| FileName | string |  文件名  |
| Content  | byte[] | 文件内容 |

#### Target字段和接口、功能实现的对照表

Target字段主要用于确定要获取的资源种类，其类型为字符串，具备良好的可扩展性。

下表列出了各个功能点中Target关键字应当如何设置：

|        实现功能        |  接口  |  Target   |           说明            |
| :--------------------: | :----: | :-------: | :-----------------------: |
| 获取生成的所有配置文件 |  GET   | "config"  |                           |
|  获取基础设施信息文件  |  GET   |  "infra"  |                           |
|     获取所有版本号     |  GET   | "version" |                           |
|      获取原始数据      |  GET   |   "raw"   |                           |
|   获取用户缓存的数据   |  GET   |  "cache"  |                           |
|      缓存配置数据      |  PUT   |   "raw"   | 目标版本号放在Version字段 |
|  提交基础设施信息文件  | COMMIT |  "infra"  |                           |
|   提交用户缓存的数据   | COMMIT |   "raw"   |                           |

#### Action字段和接口、功能实现的对照表

***此功能暂不实现。***

Action字段主要用于限定更新范围，其类型为字符串。

下表列出了各个功能点中Action关键字应当如何设置：

|   实现功能   | 接口  |         Action          |                                     说明                                     |
| :----------: | :---: | :---------------------: | :--------------------------------------------------------------------------: |
| 缓存配置数据 |  PUT  |      "ResetAtRoot"      | 在版本范围内全量更新，必须上传符合格式要求的配置数据包，必须配合其他请求参数 |
| 缓存配置数据 |  PUT  |      "ResetAtLeaf"      |                        在其他参数限定的范围内全量更新                        |
| 缓存配置数据 |  PUT  |  "AddAndReplaceAtLeaf"  |        在其他参数限定的范围内增量更新(允许文件重名，重名即覆盖原文件)        |
| 缓存配置数据 |  PUT  | "AddButNoReplaceAtLeaf" |              在其他参数限定的范围内增量更新(重名时不覆盖原文件)              |

#### Type字段和接口、功能实现的对照表

***此功能暂不实现。***

Type字段用于指定树状结构中的一层，但具有特殊限制，其用法如下：

|   实现功能   | 接口  |     Type     |     说明     |
| :----------: | :---: | :----------: | :----------: |
| 提交配置数据 |  PUT  | "deployment" | 更新部署信息 |
| 提交配置数据 |  PUT  |  "service"   | 更新服务信息 |
| 提交配置数据 |  PUT  |  "template"  | 更新配置模板 |
| 获取原始数据 |  GET  | "deployment" | 获取部署信息 |
| 获取原始数据 |  GET  |  "service"   | 获取服务信息 |
| 获取原始数据 |  GET  |  "template"  | 获取配置模板 |

#### ArgRange字段

|   变量    |   类型   |            说明            |
| :-------: | :------: | :------------------------: |
|  TopicIp  | []string |  用于生成组播地址的ip范围  |
| TopicPort | []string | 用于生成组播地址的端口范围 |
|  TcpPort  | []string |  主机上可用的tcp端口范围   |

#### CfgResp

|   变量   |   类型    |            说明            |
| :------: | :-------: | :------------------------: |
|  status  |  string   | "ok"或执行过程中的错误日志 |
| Versions | Version[] |         版本号数组         |
|   File   |  AnyFile  |          文件数据          |

#### Version

| 变量  |   类型    |         说明         |
| :---: | :-------: | :------------------: |
| Name  |  string   |   标准三段式版本号   |
| User  |  string   |  提交该版本号的用户  |
| Time  | timestamp | 提交时间的13位时间戳 |

### 接口设计

为更加直观的展示rpc交互过程，以下接口原型均使用proto协议语法进行描述。

#### GET

GET接口用于让各个交互方能从配置中心获取文件，包括基础设施信息文件、上传的配置数据包、截至目前的所有历史版本号、用户缓存和配置中心生成的配置结果。

接口原型:

```proto
GET(req CfgReq) returns (resp CfgResp)
```

#### PUT

PUT接口用于实现让用户缓存本地的配置包到配置中心服务端，缓存时不对配置文件包的合法性进行校验

接口原型:

```proto
PUT(req CfgReq) returns (resp CfgResp)
```

#### DELETE

DELETE接口

DELETE接口用于删除用户在配置中心服务端缓存的配置信息

接口原型:

```proto
DELETE(req CfgReq) returns (resp CfgResp)
```

#### COMMIT

COMMIT接口用于提交基础设施信息或者配置文件包信息

接口原型：

```proto
COMMIT(req CfgReq) returns (resp CfgResp)
```

#### GetLatestConfigByEnvNum

GetLatestConfigByEnvNum接口用于让外部应用通过环境号获取最新配置

接口原型：

```proto
GetLatestConfigByEnvNum(EnvNum string) returns (file AnyFile)
```

## 配置接口

无

## 消息接口

无

## 参考数据接口

无

## 监控指标接口

暂无

## 人机接口

参考《MAL107新核心交易系统架构用户手册（配置中心卷）》

# 接口使用说明

接口使用可参考下列文档：
《MAL107新核心交易系统架构用户手册（配置中心卷）》
《TD107新核心交易系统架构总体设计文档（配置中心卷）》
