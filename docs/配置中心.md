<!-- TOC -->

- [1. 需求](#1-需求)
  - [1.1. 节点定义](#11-节点定义)
  - [1.2. 配置中心数据库组成](#12-配置中心数据库组成)
  - [1.3. 配置的组成](#13-配置的组成)
    - [1.3.1. 应用配置](#131-应用配置)
    - [1.3.2. 部署与操控配置](#132-部署与操控配置)
    - [1.3.3. 接口配置](#133-接口配置)
  - [1.4. 配置中心应用](#14-配置中心应用)
  - [1.5. 测试的安排](#15-测试的安排)
  - [1.6. 版本更新](#16-版本更新)
  - [1.7. 节点启动](#17-节点启动)
  - [1.8. 环境](#18-环境)
- [2. 总体设计](#2-总体设计)
  - [2.1. 系统结构](#21-系统结构)
  - [2.2. 数据模型](#22-数据模型)
    - [2.2.1. 层级结构](#221-层级结构)
    - [2.2.2. 物理设施配置](#222-物理设施配置)
    - [2.2.3. 制品库映射](#223-制品库映射)
    - [2.2.4. 节点配置](#224-节点配置)
      - [2.2.4.1. ConfigData](#2241-configdata)
      - [2.2.4.2. Mode](#2242-mode)
      - [2.2.4.3. ConfigVersion](#2243-configversion)
      - [2.2.4.4. Environment](#2244-environment)
      - [2.2.4.5. Node](#2245-node)
      - [2.2.4.6. AppConfig](#2246-appconfig)
      - [2.2.4.7. InterfaceConfig](#2247-interfaceconfig)
      - [2.2.4.8. DeployConfig](#2248-deployconfig)
  - [2.3. etcd设计](#23-etcd设计)
    - [2.3.1. 配置](#231-配置)
- [3. 功能设计](#3-功能设计)
  - [3.1. 配置编辑与保存](#31-配置编辑与保存)
    - [3.1.1. 流程](#311-流程)
  - [3.2. 版本提交](#32-版本提交)
    - [3.2.1. 流程](#321-流程)
  - [3.3. *权限管理、发布审核、操作审计](#33-权限管理发布审核操作审计)
- [4. 接口](#4-接口)
  - [4.1. 获取配置](#41-获取配置)
    - [4.1.1. GetRequest](#411-getrequest)
    - [4.1.2. GetResponse](#412-getresponse)
    - [4.1.3. 使用说明](#413-使用说明)
  - [4.2. 保存配置](#42-保存配置)
    - [4.2.1. PutRequest](#421-putrequest)
    - [4.2.2. PutResponse](#422-putresponse)
  - [4.3. 删除配置](#43-删除配置)
    - [4.3.1. DeleteRequest](#431-deleterequest)
    - [4.3.2. DeleteResponse](#432-deleteresponse)
  - [4.4. 提交版本](#44-提交版本)
    - [4.4.1. CommitRequest](#441-commitrequest)
    - [4.4.2. CommitResponse](#442-commitresponse)
  - [4.5. 导入](#45-导入)
    - [4.5.1. ImportRequest](#451-importrequest)
    - [4.5.2. ImportResponse](#452-importresponse)
  - [4.6. 导出](#46-导出)
    - [4.6.1. ExportRequest](#461-exportrequest)
    - [4.6.2. ExportResponse](#462-exportresponse)

<!-- /TOC -->

# 1. 需求

## 1.1. 节点定义

节点为分布式模块的最小单位，可以部署在相同主机/不同主机/物理或虚拟服务器上，由节点编号全局唯一标识

1. 节点编号：每个节点的编号，全局唯一（如何命名这个唯一的节点编号）
2. 所属平台：系统中的各个平台，如DTP/MTP/EzEI/EzCS等
3. 平台类型：在一个平台内的角色，如MC/RC/Data等
4. 类型分区：一个平台内相同角色的分区，如DTP的MC的Set1
5. 环境号：影响应用使用的端口号，如88环境，00环境等

1-4组合，决定此节点的参考数据
1-5组合，决定此节点的配置
2-5组合与全局唯一的节点编号一一对应

## 1.2. 配置中心数据库组成

1. 部分为CMDB中数据内容，包含硬件配置信息等
2. 节点配置分环境保存，环境之下分平台节点保存
3. 配置分为最新库和历史库，历史库存放历史版本
4. 配置中心另有独立IP的测试库，专供周末测试，交易日不运行，预防误访问（交易日不可见）

## 1.3. 配置的组成

### 1.3.1. 应用配置

1. 每个节点应用的配置信息，跟随版本而变化

### 1.3.2. 部署与操控配置

1. 每个节点应用的部署配置信息，可以跟随版本也可单独调整
2. 供自动化部署系统使用

### 1.3.3. 接口配置

1. 描述应用的对外对内数据接口
2. 包括文件及其传输路径/消息中间件主题信息/TCP服务端口信息等
3. 其他节点或者监控程序或者文件传输系统均可每日访问此信息

## 1.4. 配置中心应用

1. 对配置进行维护和更新
2. 每日对配置进行稽核和配置项之间的勾稽关系检查

## 1.5. 测试的安排

1. 周末测试准备好测试数据后，仅需要变更每个节点所连接的配置中心
2. 测试完毕后修改连接信息

## 1.6. 版本更新

1. 版本更新时更新配置中心
2. 部署配置信息独立提交，提交时进行自动化稽核
3. 根据生产环境配置，按照环境间差异，生成其他环境配置

## 1.7. 节点启动

1. 节点启动时通知Agent获取最新配置
2. Agent获取最新配置并与上一交易日配置进行比对
3. 如有不同并且此配置版本未更新，并且并非在两个交易日之间修改则报警
4. 节点读取T日配置，启动

## 1.8. 环境

开发测试环境（开发可以访问）

以下只有运维可以访问，网络隔离:
全真环境
周二、周四的88环境，硬件与生产环境一样
周末全市场通关（演练）的00环境

# 2. 总体设计

## 2.1. 系统结构

![alt](svg/配置中心结构设计-总体架构.svg)

配置中心的系统结构如图，具体如下：

1. 配置服务提供配置的读写、版本管理等功能；
2. 配置端通过http访问配置服务；
3. 配置服务向etcd读写配置内容、版本信息；
4. 部署/操作中心通过etcd获取配置信息。

## 2.2. 数据模型

### 2.2.1. 层级结构

![alt](svg/配置中心结构设计-层级结构.svg)

### 2.2.2. 物理设施配置

|   变量   |  类型  |  说明  |
| :------: | :----: | :----: |
| hostname | string | 主机名 |
| network  | string | 子网号 |
|    ip    | string | ip地址 |

hostname,network->ip

### 2.2.3. 制品库映射

platform/type/appVer -> ?

### 2.2.4. 节点配置

#### 2.2.4.1. ConfigData

| 变量  |  类型  |         说明         |
| :---: | :----: | :------------------: |
| modes | Mode[] | 配置数据中的所有模式 |

#### 2.2.4.2. Mode

|   变量   |      类型       |         说明          |
| :------: | :-------------: | :-------------------: |
| modeName |     string      | 工作模式（测试/正常） |
| cfgVers  | ConfigVersion[] |  该模式中的所有版本   |

#### 2.2.4.3. ConfigVersion

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :----------------------------------: |
| version |    string     | 配置版本（username表示用户缓存配置） |
|  envs   | Environment[] |          该版本中的所有环境          |

#### 2.2.4.4. Environment

| 变量  |  类型  |        说明        |
| :---: | :----: | :----------------: |
|  num  | string |       环境号       |
| nodes | Node[] | 该环境中的所有节点 |

#### 2.2.4.5. Node

|     变量     |      类型       |   说明   |
| :----------: | :-------------: | :------: |
|    nodeId    |     string      | 节点编号 |
|   platform   |     string      |   平台   |
|     type     |     string      |   类型   |
|     part     |     string      |   分区   |
|   appCfgs    |   AppConfig[]   | 应用配置 |
| interfaceCfg | InterfaceConfig | 接口配置 |
|  deployCfg   |  DeployConfig   | 部署配置 |

#### 2.2.4.6. AppConfig

|  变量   |  类型  |   说明   |
| :-----: | :----: | :------: |
|  name   | string |  配置名  |
| format  | string | 配置格式 |
| content | string | 配置内容 |

#### 2.2.4.7. InterfaceConfig

> 后期由应用决定

#### 2.2.4.8. DeployConfig

|   变量   |  类型  |   说明   |
| :------: | :----: | :------: |
|  appVer  | string | 应用版本 |
|   path   | string | 部署目录 |
| hostname | string |  主机名  |
| network  | string |  子网号  |
| usename  | string |  用户名  |

## 2.3. etcd设计

### 2.3.1. 配置

|                                     key                                      |      value      |             说明             |
| :--------------------------------------------------------------------------: | :-------------: | :--------------------------: |
| /\$mode/\$cfgVer/\$env/\$platform/\$type/\$part/\$id/appCfgs/\$name/\$format |    AppConfig    |         应用配置内容         |
|        /\$mode/\$cfgVer/\$env/\$platform/\$type/\$part/\$id/deployCfg        |  DeployConfig   |         部署配置内容         |
|      /\$mode/\$cfgVer/\$env/\$platform/\$type/\$part/\$id/interfaceCfg       | InterfaceConfig |         接口配置内容         |
|                                 /cfgVerLock                                  |       0/1       |          版本提交锁          |
|                                  /modeList                                   |     Mode[]      |      当前包含的所有模式      |
|                              /\$mode/cfgVerList                              | ConfigVersion[] |  当前模式中包含的所有版本号  |
|                               /\$mode/lastVer                                |     version     |    当前模式中的最新版本号    |
|                           /\$mode/\$cfgVer/envList                           |  Environment[]  |  当前版本中包含的所有环境号  |
|                       /\$mode/\$cfgVer/\$env/nodeList                        |     Node[]      |   当前环境中包含的所有节点   |
|       /\$mode/\$cfgVer/\$env/\$platform/\$type/\$part/\$id/appCfgList        |   AppConfig[]   | 当前节点中包含的所有应用配置 |

# 3. 功能设计

## 3.1. 配置编辑与保存

### 3.1.1. 流程

![alt](svg/配置中心结构设计-配置发布.svg)

1. 修改配置时，以某个版本为基准，将该版本中所有节点的配置写入配置缓存
2. 保存时，以一条key、value记录为单位，即单个节点的单个配置内容为单位，写入配置缓存

## 3.2. 版本提交

### 3.2.1. 流程

![alt](svg/配置中心结构设计-版本提交.svg)

## 3.3. *权限管理、发布审核、操作审计

# 4. 接口

## 4.1. 获取配置

| 接口名 |    输入    |    输出     | 说明  |
| :----: | :--------: | :---------: | :---: |
|  Get   | GetRequest | GetResponse |       |

### 4.1.1. GetRequest

|    变量    |    类型    |                 说明                 |
| :--------: | :--------: | :----------------------------------: |
| configData | ConfigData | 通过构建ConfigData表示需要查询的内容 |

### 4.1.2. GetResponse

|    变量    |    类型    |   说明   |
| :--------: | :--------: | :------: |
|   result   |   string   | 请求结果 |
| configData | ConfigData | 查询结果 |

### 4.1.3. 使用说明

用户构建ConfigData到自己想要查询到那一级。
如，查询Normal模式下的所有ConfigVersion，则请求中的ConfigData结构为：

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[]
    }
  ]
}
```

服务会向下填充一级内容，即回复的ConfigData结构为：

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[
        {
          "version":"v1.00",
          "envs":[]
        },
        {
          "version":"v0.10",
          "envs":[]
        }
      ]
    }
  ]
}

```

回复的ConfigData中，只往下填写了一级的信息，即Normal模块中所有的版本号，而版本号中的envs没有填充。
限制每次只支持查询一个对象，即如果请求中ConfigData包含多个Mode，则会回复错误信息，如下。

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[]
    },
    {
      "ModeName":"Test",
      "cfgVers":[]
    }
  ]
}
```

## 4.2. 保存配置

| 接口名 |    输入    |    输出     | 说明  |
| :----: | :--------: | :---------: | :---: |
|  Put   | PutRequest | PutResponse |       |

### 4.2.1. PutRequest

|    变量    |    类型    |    说明    |
| :--------: | :--------: | :--------: |
| configData | ConfigData | 保存的数据 |

### 4.2.2. PutResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 4.3. 删除配置

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Delete | DeleteRequest | DeleteResponse |       |

### 4.3.1. DeleteRequest

|    变量    |    类型    |      说明      |
| :--------: | :--------: | :------------: |
|  username  |   string   |     用户名     |
| configData | ConfigData | 需要删除的数据 |

### 4.3.2. DeleteResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 4.4. 提交版本

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Commit | CommitRequest | CommitResponse |       |

### 4.4.1. CommitRequest

|   变量   |  类型  |    说明    |
| :------: | :----: | :--------: |
| modeName | string | 当前的模式 |
| username | string | 当前的用户 |

### 4.4.2. CommitResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 4.5. 导入

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Export | ImportRequest | ImportResponse |       |

### 4.5.1. ImportRequest

|    变量    |    类型    | 说明  |
| :--------: | :--------: | :---: |
| configData | ConfigData |       |

### 4.5.2. ImportResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 4.6. 导出

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Export | ExportRequest | ExportResponse |       |

### 4.6.1. ExportRequest

|    变量    |    类型    |        说明        |
| :--------: | :--------: | :----------------: |
| configData | ConfigData | 表示需要导出的层级 |

### 4.6.2. ExportResponse

|    变量    |    类型    |     说明     |
| :--------: | :--------: | :----------: |
|   result   |   string   |              |
| configData | ConfigData | 填充后的结果 |
