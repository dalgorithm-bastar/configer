[toc]

# 配置中心简介

配置中心实现对配置文件的托管、版本化管理和动态生成。在接到生成请求时，配置中心按照本地输入或服务端存储的基础设施信息文件、部署信息文件、服务信息文件中所声明的要求，分配各个集群的集群ID、节点ID等参数，在确定部署参数后为每个集群分配组播信息，然后使用这些信息中的一部分，填充各个节点类型的配置模板，生成对应于每个节点的配置文件，最终将生成的配置文件打包返回给用户。

基础设施信息文件作为相对特殊的文件，实行单独管理。除了配置文件，用户还可从配置中心服务端获取包括配置文件包、用户缓存的配置文件包和基础设施信息文件在内的多种文件。

# 构建输入文件

## 基础设施信息文件infrastructure.yaml

基础设施信息文件需要单独上传，单独获取，并且整个配置中心内仅保留一份，没有版本号。基础设施信息文件的名称必须是infrastructure.yaml。**若文件中字段的值存在空值，请在使用前将空值对应的字段删除，否则在生成时会报错**。该机制是为了校验用户填写的文件，判断其是否符合预期。

### 字段表

根结构：

| 字段  |    类型    |   含义   |
| :---: | :--------: | :------: |
| host  | []hostUnit | 主机列表 |

hostUnit:

|   字段   |    类型    |   含义   |
| :------: | :--------: | :------: |
| hostname |   string   | 主机名称 |
| location |   string   | 主机位置 |
| network  | []netWork  | 网卡列表 |
|   user   | []userUnit | 用户列表 |

netWork:

|  字段   |  类型  |        含义        |
| :-----: | :----: | :----------------: |
|  name   | string | 该网卡对应的网络名 |
| adapter | string |      网卡名称      |
|  ipv4   | string |   网卡绑定的ipv4   |

userUnit:

| 字段  |  类型  |  含义  |
| :---: | :----: | :----: |
| name  | string | 用户名 |

### infrastructure.yaml示例

```yaml
host:
  - hostName: host1
    location: jinqiao
    network: 
      - name: intranet
        adapter: a1
        ipv4: "197.3.2.1"
      - name: extranet
        adapter: a2
        ipv4: "10.112.3.1"
      - name: biznet
        adapter: a3
        ipv4: "224.1.2.1"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host2
    location: jinqiao
    network: 
      - name: intranet
        adapter: a4
        ipv4: "197.3.2.2"
      - name: extranet
        adapter: a5
        ipv4: "10.112.3.2"
      - name: biznet
        adapter: a6
        ipv4: "224.1.2.2"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host3
    location: jinqiao
    network: 
      - name: intranet
        adapter: a7
        ipv4: "197.3.2.3"
      - name: extranet
        adapter: a8
        ipv4: "10.112.3.3"
      - name: biznet
        adapter: a9
        ipv4: "224.1.2.3"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host4
    location: jinqiao
    network: 
      - name: intranet
        adapter: a10
        ipv4: "197.3.2.4"
      - name: extranet
        adapter: a11
        ipv4: "10.112.3.4"
      - name: biznet
        adapter: a12
        ipv4: "224.1.2.4"
    user: 
      - name: cfgu
      - name: xwang3
```

## 配置文件包

### 总体结构

先给出一个符合要求的配置文件包的结构示例:

```shell
.
├── 3.1.0
│   └── scheme1
│       ├── DTP
│       │   ├── CS
│       │   │   ├── deployment
│       │   │   │   ├── set1
│       │   │   │   │   └── deployment.yaml
│       │   │   │   └── set2
│       │   │   │       └── deployment.yaml
│       │   │   ├── service
│       │   │   │   ├── engine1
│       │   │   │   │   └── service.yaml
│       │   │   │   └── service.yaml
│       │   │   └── template
│       │   │       ├── app_shl.toml
│       │   │       └── so1
│       │   │           ├── so1.toml
│       │   │           ├── so1_1
│       │   │           │   └── nilfile.toml
│       │   │           └── so1_2empty
│       │   └── MC
│       │       ├── deployment
│       │       │   ├── set1
│       │       │   │   └── deployment.yaml
│       │       │   └── set2
│       │       │       └── deployment.yaml
│       │       ├── service
│       │       │   └── service.yaml
│       │       └── template
│       │           └── app_shl.toml
│       └── MTP
│           └── RC
│               ├── deployment
│               │   ├── set1
│               │   │   └── deployment.yaml
│               │   └── set2
│               │       └── deployment.yaml
│               ├── service
│               │   └── service.yaml
│               └── template
│                   └── app_shl.toml
└── infrastructure.yaml
```

一个符合要求的配置文件包的目录树，应当满足以下要求：

- 根目录只有一个
- 一级目录代表配置方案名称
- 二级目录代表平台名称
- 三极目录代表特定节点类型
- 四级目录**只能填写template、service或deployment**，分别代表放置配置模板、服务声明、部署信息的文件夹，且文件夹路径**其他位置不得包含这几个关键字**
- deployment目录下必须有一层set子目录，放置某个集群的部署信息文件
- 部署信息文件的名称必须为deployment.yaml，服务声明文件的名称必须为service.yaml
- 在本地模式下生成时，配置文件包同级目录下必须包含基础设施信息文件infrastructure.yaml。在上传配置包到服务端时无此要求

以下是一些值得注意的提示：

- service文件夹下可按不同的so文件建立子文件夹，分别描述各个so的服务声明。文件夹下也可放置整个节点类型的服务声明，配置中心在生成组播信息时会进行整合和去重
- template文件夹下可任意设置文件夹，可放置任意文本文件。生成配置文件包后，该文件夹下的文件会按照相对于template文件夹的位置，放置在指定的配置文件夹下（由操控中心执行，人工和本地模式下需手动分发）。template文件夹下的文件夹和文件权限，在生成结果中保持不变。

### 服务声明文件service.yaml

服务声明文件又称为服务信息文件。服务声明文件能够完整的记录一个节点类型的集群内组播通道以及在各张网卡上的业务组播通道、集群组播通道。生成组播信息时，配置中心即以此文件为依据。**若文件中字段的值存在空值，请在使用前将空值对应的字段删除，否则在生成时会报错**。该机制是为了校验用户填写的文件，判断其是否符合预期。对于订阅方来说只需要配置业务组播通道列表，集群组播通道列表没有实际意义，即使配置了也不会生效。

#### 字段表

根结构：

|     字段      |   类型    |             含义             |
| :-----------: | :-------: | :--------------------------: |
| innerTopicNet |  string   |     集群内通信使用的网络     |
|   pubTopic    | []netUnit | 某个网络下的组播信息发布声明 |
|   subTopic    | []netUnit | 某个网络下的组播信息订阅声明 |

netUnit:

|   字段   |    类型     |       含义       |
| :------: | :---------: | :--------------: |
| netName  |   string    |      网络名      |
| bizTopic | []topicUnit | 业务组播通道列表 |
| setTopic | []topicUnit | 集群组播通道列表 |

topicUnit：

|  字段   |  类型  | 含义   |
| :-----: | :----: |:------------------------------: |
| topicName | string | 组播通道名称，当其为setTopic时，名称必须为平台.节点类型(见示例)；同一方案内bizTopic不允许重复 |
|  isRMB  | uint16 |                                  判断该组播是否可靠的标志位              |

#### service.yaml示例

```yaml
innerTopicNet: intranet
pubTopic: 
 - netName: extranet
   setTopic: 
    - topicName: DTP.MC
      isRMB: 1
    - topicName: MTP.RC
      isRMB: 1

```

### 部署信息文件deployment.yaml

部署信息文件用于记录一个集群（set）中每个节点部署在哪台机器上，同时记录部署文件夹、制品路径等信息。**若文件中字段的值存在空值，请在使用前将空值对应的字段删除，否则在生成时会报错**。该机制是为了校验用户填写的文件，判断其是否符合预期。

#### 字段表

根结构：

|    字段    |       类型       |                                         含义                                          |
| :--------: | :--------------: | :-----------------------------------------------------------------------------------: |
| artifact | artifactUnit |                                       制品信息                                        |
|    node    |    []hostUnit    | 该结构与infrastructure.json中的[]hostUnit相同。声明部署信息时只需填入目标主机名称即可 |

artifactUnit:

|    字段    |  类型  |      含义      |
| :--------: | :----: | :------------: |
|    url     | string |    制品路径    |
| deployPath | string |    部署路径    |
| configPath | string | 配置文件夹路径 |

#### deployment.yaml 示例

```json
artifact: 
  url: "127.0.0.1:8080"
  deployPath: "/User/sseadmin/CS/set1"
  configPath: "config"
node:
  - hostName: "host1"
```

### 配置模板组

配置模板组放置在template文件夹下，该文件夹内的文件都会在生成对应节点类型下某节点的配置文件时被按要求填充。值得注意的是，用户不是一定要利用这个机制，即该用户可以不使用替换功能，这不影响原生的配置文件。要进行填充时，遵循下表中的用法示例即可

#### 可填充信息表

|   字段    |  类型  |         含义          |    用法示例    |
| :-------: | :----: | :-------------------: | :------------: |
| platName  | string |  节点所处的平台名称   | {{.Platform}}  |
| nodeType  | string |   节点的节点类型名    | {{.NodeType}}  |
|  nodeId   | uint16 |  节点编号（全局唯一）  |  {{.NodeId}}   |
| nodeIndex | uint16 | 节点在集群中的偏移量   | {{.NodeIndex}} |
| nodeNum   | uint16 |  集群中包含的节点个数  | {{.NodeNum}} |
|   setId   | uint16 | 节点所处集群的集群编号 |   {{.SetId}}   |
| setIndex  | uint16 | 节点所处集群在节点类型中的偏移量 | {{.SetIndex}}  |
|  setName  | string |   节点所处集群的名称   |  {{.SetName}}  |

#### 可使用的填充函数

在配置模板中预设两个函数如下：

```go
//根据网络名称获取该节点部署的主机上对应网卡的IP
//输入为网络名称
//输出为IP地址或可能的错误
func GetIpByNet(netName string)(IP string,err error){}

//获取该节点部署的主机上下一个可用的TCP端口
//无输入
//输出为该主机上下一个可用的tcp端口号或可能的错误
func GetNextTcpPort()(port string,err error){}
```

函数用法示例如下： 示例输入文件：

```shell
{{GetIpByNet "biz_net"}}
{{GetNextTcpPort}}
```

#### 示例文件app_shl.toml

```toml
[Information]
platName="{{.PlatName}}"
nodeType="{{.NodeType}}"
nodeId={{.NodeId}}
nodeIndex={{.NodeIndex}}
nodeNum={{.NodeNum}}
setID={{.SetId}}
setName="{{.SetName}}"
setIndex={{.SetIndex}}
ipv4="{{GetIpByNet "biz_net"}}"
port="{{GetNextTcpPort}}"
```

用某个节点的信息填充后的效果：

```toml
[Information]
platName="DTP"
nodeType="MC"
nodeId=5
nodeIndex=1
nodeNum=2
setID=3
setName="set1"
setIndex=1
ipv4="10.112.1.1"
port="32768"
```

# 使用配置中心

## 修改配置文件

配置中心客户端和服务端文件夹内均包含配置文件夹config **（若仅需用到离线模式，可以跳过这一小节）**。

打开config文件夹内的configcenter.json文件，其结构如下：

```json
{
  "etcd": {
    "endpoints": [
      "127.0.0.1:2379"
    ],
    "username": "root",
    "password": "12345678",
    "operationtimeout": 3
  },
  "grpc": {
    "socket": "127.0.0.1:2333",
    "locktimeout": 30
  },
  "log": {
    "logpath": "log/",
    "recordlevel": "info",
    "encodingtype": "normal",
    "filename": "configcenter",
    "maxage": 30
  }
}
```

各字段含义如下：

|         字段          |   类型   |                    含义                    |
| :-------------------: | :------: | :----------------------------------------: |
|    etcd.endpoints     | []string |       服务端监听的etcd端点（ip:port）       |
|     etcd.username     |  string  |                 etcd用户名                 |
|     etcd.password     |  string  |                  etcd密码                  |
| etcd.operationtimeout |   int    |      etcd单次操作的超时时间，单位为秒        |
|      grpc.socket      |  string  |           grpc监听的端点（ip:port）         |
|   grpc.locktimeout    |   int    |   commit操作时数据库单次加锁的时间，单位为秒  |
|      log.logpath      |  string  |             日志文件的生成路径              |
|    log.recordlevel    |  string  |                日志记录等级                 |
|   log.encodingtype    |  string  |                  日志格式                  |
|     log.filename      |  string  |             日志文件的前缀名称              |
|      log.maxage       |   int    |      新日志文件保存的最长时间，单位为天       |

- log.recordlevel 可选项为"debug"和"info"，不填或填错则默认为"info"等级。
- log.encodingtype 可选项为"normal"（人类阅读友好）和"json"（json格式化输出，机器阅读友好），不填或填错则默认为"normal"。
- 使用配置中心客户端或服务端之前，请先将按照实际情况修改配置文件。

## Target字段和接口、功能实现的对照表

Target字段主要用于确定要获取的资源种类，其类型为字符串，具备良好的可扩展性，在命令行中使用-t或--target指定该字段。

下表列出了各个功能点中Target关键字应当如何设置：

|     实现功能    |      接口      |      Target    | 说明 |
| :------------: | :-----------: | :-------------: | :-------------: |
| 获取生成的所有配置文件 |      GET       | "config" |  |
| 获取基础设施信息文件 |      GET       | "infra" |  |
| 获取所有版本号 |      GET       | "version" |   |
| 获取某个版本的原始数据 |      GET       | "raw" |   |
| 获取用户缓存的数据 | GET | "cache" |  |
|  缓存配置数据   |      PUT       |  "raw"  | 目标版本号放在Version字段 |
|  提交基础设施信息文件   |      COMMIT       |  "infra"  |  |
|  提交用户缓存的数据   |      COMMIT       |  "raw"  |  |

## 上传基础设施信息文件

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl commit -u username -t infra -i path/to/infrastructure.yaml
```

使用"-h"参数可查看以下帮助信息

```shell
commit command is used for submit the configfile under the username selected.
you can either assign version number in flag --version or leave it as default
attention that you have to put configfile first;otherwise,commit infrastructure is also supported

Usage:
  proxctl commit [flags]

Flags:
  -h, --help             help for commit
  -i, --pathin string    assign input path, only for infrastructure
  -t, --target string    select raw or infrastructure to commit
  -v, --version string   put version number here if you want

Global Flags:
  -u, --user string   current userName(required)
```

## 缓存配置文件包

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl put -u chqr -i path/to/pkgDir
```

使用"-h"参数可查看以下帮助信息

```shell
put command enables you to save config file under your username on remote
attention that the configfile would not be submit.
learn more about that on command "post"

Usage:
  proxctl put [flags]

Flags:
  -h, --help            help for put
  -i, --pathin string   assign input path of compressedfile(required)

Global Flags:
  -u, --user string   current userName(required)
```

## 提交配置文件包

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl commit -u chqr -t raw -v targetVersion
```

- 若指定targetVersion，必须满足三段式版本号版本

- 提交成功后，命令行会输出本次提交的版本号、提交用户、提交时间

## 生成配置文件包以及获取更多文件

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl get -u chqr -t config -v 0.0.2 -s scheme1 -e 02 \
-m remote -o path/to/res --topicIp 156.10.1.1,156.10.1.6,156.10.11.1,156.10.11.6 \
--topicPort 10000,32768 --tcpPort 10000,32768
```

其中topicIp、topicPort、tcpPort为逗号分隔字符串，ip或端口个数必须为偶数以组成段落，每两个ip代表一段可用ip的闭区间，传参时无需考虑ip、port的大小顺序，配置中心将自动处理。ip对之间的范围可重复，也可完全包含，生成时将自动处理。-e参数为环境号，必须为两位数字，将被用于替换所有端口号的倒数第二、三位

使用"-h"参数可查看以下帮助信息，根据帮助信息修改-t参数，还可获取基础设施信息文件、配置数据包、用户缓存、版本号列表

```shell
Get file from remote or local

Usage:
  proxctl get [flags]

Flags:
  -c, --cluster(set) string   assign a cluster(set) name
  -e, --env string            assign an env num of 2 bits(required)
  -h, --help                  help for get
  -m, --mode string           input "remote" or "local" to choose creating from remote or local(required)
  -n, --nodetype string       assign config nodetype
  -i, --pathin string         assign input path
  -o, --pathout string        assign output path(required)
  -l, --platform string       assign platform
  -s, --scheme string         assign config scheme
  -t, --target string         assign target file Type within raw,cache,infra,version,config
      --tcpPort string        assign TCP Port range(required)
      --topicIp string        assign Topic IP range(required)
      --topicPort string      assign Topic Port range(required)
  -y, --type string           assign data type within deployment,service,template
  -v, --version string        assign a config version

Global Flags:
  -u, --user string   current userName(required)
```

## 本地模式

本地模式下可以利用本地的一套基础设施信息和配置数据包，离线生成一套配置数据。进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl get -u chqr -t config -e 01 -v 3.1.0 -s scheme1 -m local \
-i path/to/cfgpkg -o path/to/res --topicIp 156.10.1.1,156.10.11.2 \
 --topicPort 10000,32768 --tcpPort 20000,40000
```

帮助信息与上文中一致，-m参数必须为local。-i指定到配置数据包的根目录，在执行命令之前必须将infrastructure.yaml文件放在配置数据包根目录的同级目录下

## 启动配置中心服务端

进入配置中心服务端可执行文件proxima的同级文件夹，执行以下命令：

```shell
./proxima start
```

使用"-h"参数可查看以下帮助信息。可根据信息手动输入配置文件路径

```shell
server of ConfigCenter

Usage:
  proxima [command]

Available Commands:
  completion  generate the autocompletion script for the specified shell
  help        Help about any command
  start       start configCenter server
  version     basic information of proxima

Flags:
      --config string   config file (default is config/configcenter.json)
  -h, --help            help for proxima

Use "proxima [command] --help" for more information about a command.
```

## 查看配置中心版本信息

进入配置中心服务端可执行文件proxima的同级文件夹，或进入配置中心服务端可执行文件proxima的同级文件夹，执行以下命令：

```shell
./proxctl version -u username

./proxima version -u username
```

将得到以下格式的输出：

```shell
Version :  3.1.0
GoVersion :  go version go1.18 darwin/amd64
GitBranch :  3.1.0
GitCommit :  914e79357bf4b67ebba89edf39943b8f6f82c4a5
GitLatestTag :  3.1.0
BuildTime :  2022-05-23 15:36:14 CST
```

# 配置文件生成结果

## 总体结构

### 示例

假设输出路径指定到res目录，则一个用于示例的生成结果的文件目录如下：

```shell
resyml
└── 3.1.0_scheme1
    ├── huarui_files
    │   ├── host.cfg
    │   ├── node.cfg
    │   └── route.cfg
    └── origin_res
        ├── DTP
        │   ├── CS
        │   │   ├── set1
        │   │   │   ├── deployment.yaml
        │   │   │   ├── host1_1
        │   │   │   │   ├── app_shl.toml
        │   │   │   │   └── so1
        │   │   │   │       ├── so1.toml
        │   │   │   │       ├── so1_1
        │   │   │   │       │   └── nilfile.toml
        │   │   │   │       └── so1_2empty
        │   │   │   └── topicInfo.json
        │   │   └── set2
        │   │       ├── deployment.yaml
        │   │       ├── host2_2
        │   │       │   ├── app_shl.toml
        │   │       │   └── so1
        │   │       │       ├── so1.toml
        │   │       │       ├── so1_1
        │   │       │       │   └── nilfile.toml
        │   │       │       └── so1_2empty
        │   │       └── topicInfo.json
        │   └── MC
        │       ├── set1
        │       │   ├── deployment.yaml
        │       │   ├── host1_3
        │       │   │   └── app_shl.toml
        │       │   ├── host2_4
        │       │   │   └── app_shl.toml
        │       │   └── topicInfo.json
        │       └── set2
        │           ├── deployment.yaml
        │           ├── host3_5
        │           │   └── app_shl.toml
        │           ├── host4_6
        │           │   └── app_shl.toml
        │           └── topicInfo.json
        ├── MTP
        │   └── RC
        │       ├── set1
        │       │   ├── deployment.yaml
        │       │   ├── host1_7
        │       │   │   └── app_shl.toml
        │       │   ├── host2_8
        │       │   │   └── app_shl.toml
        │       │   └── topicInfo.json
        │       └── set2
        │           ├── deployment.yaml
        │           ├── host3_9
        │           │   └── app_shl.toml
        │           ├── host4_10
        │           │   └── app_shl.toml
        │           └── topicInfo.json
        ├── deployList.yaml
        └── topicList.json
```

### 文件分级说明

结合4.1.1中作为的示例生成结果，可以看到生成的文件包结构有以下特点：

- 根目录为一个名称为版本号+下划线+配置方案名称的文件夹
- 根目录下包含一个名为origin_res的文件夹，该文件夹为自研方案生成的配置文件结果。其下包含一个名为topicList.json的组播信息总表、一个名为deployList.yaml的部署信息总表和以平台名-节点类型名-集群名三级结构构成的多个目录
- 在集群目录下，包含一个topicInfo.json文件，用于记录该集群的所有组播信息，包含一个deployment.yaml文件，用于记录该集群中所有节点的部署信息
- 在集群目录下，该集群的每个节点对应一个专属文件夹，其中存放了该节点生成后的配置文件。此类专属文件夹的命名规则为**节点部署的主机名称_节点Id**
- 第三方组件需要的配置文件放置在以其小写全拼+下划线+files命名的文件夹中，示例中可见包含了华锐所需的第三方文件

## 集群内组播信息文件topicInfo.json

### 字段

文件中包含的所有id和index都从1开始自增，仅在集群内通信的"extra1"和"extra2"组播通道信息内会出现0值。

根结构：

|    字段    |      类型       |               含义               |
| :--------: | :-------------: | :------------------------------: |
|   inner    | []topicInfoUnit | 用于表述一个节点上的一条组播信息 |
| pub_extern |   externUnit    |       该集群发布的组播信息       |
| sub_extern |   externUnit    |       该集群接收的组播信息       |

externUnit:

|   字段   |      类型       |           含义           |
| :------: | :-------------: | :----------------------: |
| bizTopic | []topicInfoUnit | 用于表述业务类型组播信息 |
| setTopic | []topicInfoUnit | 用于表述集群类型组播信息 |

topicInfoUnit:

|    字段     |  类型   |                                含义                                |
| :---------: | :-----: | :----------------------------------------------------------------: |
|  topicName  | string  |                            组播通道名称                            |
|   topicId   | uint16  |                               组播Id                               |
|  endPoint   | string  |                              组播地址                              |
|  pubSetId   | unit16  |                            发布方集群Id                            |
| pubSetIndex | uint16  |                    发布方集群在节点类型内的索引                    |
| pubCluster  | string  |             发布方名称，命名规则为平台+节点类型+集群名             |
|  subSetId   | unit16  |                            接收方集群Id                            |
| subSetIndex | uint16  |                    接收方集群在节点类型内的索引                    |
| subCluster  | string  |             接收方名称，命名规则为平台+节点类型+集群名             |
| listenPort  | string  |                    表示某台主机绑定的tcp端口号                     |
|   nodeId    | uint16  |                               节点Id                               |
|  nodeIndex  | unit16  |                         节点在集群内的索引                         |
|    isRMB    | uint16  |                         表示该组播是否可靠                         |
|     net     | netWork | 同infrastructure中的同名结构，表示该组播对应网络在本机上的对应网卡 |

### 示例

该示例只用于结构展示，并不代表实际集群，也不包含完整功能

```json
{
    "inner": [
        {
            "topicName": "follow",
            "pubCluster": "DTP.CS.set1",
            "pubSetId": 4,
            "pubSetIndex": 2,
            "subCluster": "",
            "subSetId": 0,
            "subSetIndex": 0,
            "listenPort": "2019",
            "topicId": 25,
            "endPoint": "156.10.1.25:10010",
            "nodeId": 6,
            "nodeIndex": 1,
            "isRMB": 0,
            "net": {
                "name": "intranet",
                "adapter": "a1",
                "ipv4": "197.3.2.1",
                "ipv6": ""
            }
        },
        {
            "topicName": "main",
            "pubCluster": "DTP.CS.set1",
            "pubSetId": 4,
            "pubSetIndex": 2,
            "subCluster": "",
            "subSetId": 0,
            "subSetIndex": 0,
            "listenPort": "",
            "topicId": 26,
            "endPoint": "156.10.1.26:10010",
            "nodeId": 0,
            "nodeIndex": 0,
            "isRMB": 0,
            "net": {
                "name": "",
                "adapter": "",
                "ipv4": "",
                "ipv6": ""
            }
        }
    ],
    "pub_extern": {
        "biz_topic": null,
        "set_topic": [
            {
                "topicName": "DTP.MC",
                "pubCluster": "DTP.CS.set1",
                "pubSetId": 4,
                "pubSetIndex": 2,
                "subCluster": "DTP.MC.set2",
                "subSetId": 3,
                "subSetIndex": 1,
                "listenPort": "",
                "topicId": 17,
                "endPoint": "156.10.1.17:10010",
                "nodeId": 6,
                "nodeIndex": 1,
                "isRMB": 1,
                "net": {
                    "name": "extranet",
                    "adapter": "a2",
                    "ipv4": "10.112.3.1",
                    "ipv6": ""
                }
            },
            {
                "topicName": "MTP.RC",
                "pubCluster": "DTP.CS.set1",
                "pubSetId": 4,
                "pubSetIndex": 2,
                "subCluster": "MTP.RC.set1",
                "subSetId": 2,
                "subSetIndex": 1,
                "listenPort": "",
                "topicId": 21,
                "endPoint": "156.10.1.21:10010",
                "nodeId": 6,
                "nodeIndex": 1,
                "isRMB": 1,
                "net": {
                    "name": "extranet",
                    "adapter": "a2",
                    "ipv4": "10.112.3.1",
                    "ipv6": ""
                }
            }
        ]
    },
    "sub_extern": {
        "biz_topic": [
            {
                "topicName": "risk",
                "pubCluster": "MTP.RC.set1",
                "pubSetId": 2,
                "pubSetIndex": 1,
                "subCluster": "DTP.CS.set1",
                "subSetId": 4,
                "subSetIndex": 2,
                "listenPort": "",
                "topicId": 1,
                "endPoint": "156.10.1.1:10010",
                "nodeId": 6,
                "nodeIndex": 1,
                "isRMB": 1,
                "net": {
                    "name": "extranet",
                    "adapter": "a2",
                    "ipv4": "10.112.3.1",
                    "ipv6": ""
                }
            },
            {
                "topicName": "risk",
                "pubCluster": "MTP.RC.set2",
                "pubSetId": 5,
                "pubSetIndex": 2,
                "subCluster": "DTP.CS.set1",
                "subSetId": 4,
                "subSetIndex": 2,
                "listenPort": "",
                "topicId": 2,
                "endPoint": "156.10.1.2:10010",
                "nodeId": 6,
                "nodeIndex": 1,
                "isRMB": 1,
                "net": {
                    "name": "extranet",
                    "adapter": "a2",
                    "ipv4": "10.112.3.1",
                    "ipv6": ""
                }
            }
        ],
        "set_topic": null
    }
}
```

## 集群内部署信息文件deployment.yaml

结构与配置文件包中的结构一致，返回结果包含填充完毕的基础设施信息，一个生成后的文件示例如下

```yaml
artifact:
    url: "127.0.0.1:8080"
    deployPath: /User/sseadmin/CS/set1
    configPath: "config"
node:
    - nodeId: 1
      nodeIndex: 1
      hostName: host1
      location: jinqiao
      network:
        - name: intranet
          adapter: a1
          ipv4: 197.3.2.1
        - name: extranet
          adapter: a2
          ipv4: 10.112.3.1
        - name: biznet
          adapter: a3
          ipv4: 224.1.2.1
      user:
        - name: cfgu
        - name: xwang3
```

## 组播信息总表和部署信息总表

均由相应的集群层级的文件作为最小单元，层层建立数组，再加上当前层级的名称堆叠而成。

# 完整示例

## 本地模式

### 构建基础设施信息文件

假设目前共有4台物理机可用于部署，其参数分别为：

host1：

| 属性  |  值   | 说明  |
| :---: | :---: | :---: |
|  主机名   |  host1   |                        |
|   位置    | jinqiao  |
| 网卡1名称 |    a1    | 该网卡连接网络intranet |
|   网卡1   | ipv4地址 |       197.3.2.1        |
| 网卡2名称 |    a2    | 该网卡连接网络extranet |
|   网卡2   | ipv4地址 |       10.112.3.1       |
| 网卡3名称 |    a3    |  该网卡连接网络biznet   |
|   网卡3   | ipv4地址 |       224.1.2.1        |
| 用户1名称 |   cfgu   |
| 用户2名称 |  xwang3  |

host2：

| 属性  |  值   | 说明  |
| :---: | :---: | :---: |
|  主机名   |  host2   |
|   位置    | jinqiao  |
| 网卡1名称 |    a4    | 该网卡连接网络intranet |
|   网卡1   | ipv4地址 |       197.3.2.2        |
| 网卡2名称 |    a5    | 该网卡连接网络extranet |
|   网卡2   | ipv4地址 |       10.112.3.2       |
| 网卡3名称 |    a6    |  该网卡连接网络biznet   |
|   网卡3   | ipv4地址 |       224.1.2.2        |
| 用户1名称 |   cfgu   |
| 用户2名称 |  xwang3  |

host3：

| 属性  |  值   | 说明  |
| :---: | :---: | :---: |
|  主机名   |  host3   |
|   位置    | jinqiao  |
| 网卡1名称 |    a7    | 该网卡连接网络intranet |
|   网卡1   | ipv4地址 |       197.3.2.3        |
| 网卡2名称 |    a8    | 该网卡连接网络extranet |
|   网卡2   | ipv4地址 |       10.112.3.3       |
| 网卡3名称 |    a9    |  该网卡连接网络biznet   |
|   网卡3   | ipv4地址 |       224.1.2.3        |
| 用户1名称 |   cfgu   |
| 用户2名称 |  xwang3  |

host4：

| 属性  |  值   | 说明  |
| :---: | :---: | :---: |
|  主机名   |       host4        |
|   位置    |      jinqiao       |
| 网卡1名称 |        a10         | 该网卡连接网络intranet |
|   网卡1   |      ipv4地址      |       197.3.2.4        |
| 网卡2名称 |        a11         | 该网卡连接网络extranet |
|   网卡2   |      ipv4地址      |       10.112.3.4       |
| 网卡3名称 |        a12         |  该网卡连接网络biznet   |
|   网卡3   | ipv4地址    |224.1.2.4 |
| 用户1名称 |        cfgu        |
| 用户2名称 |       xwang3       |

则按照构建规则，基础设施信息文件infrastructure.yaml应当如下所示：

```yaml
host:
  - hostName: host1
    location: jinqiao
    network: 
      - name: intranet
        adapter: a1
        ipv4: "197.3.2.1"
      - name: extranet
        adapter: a2
        ipv4: "10.112.3.1"
      - name: biznet
        adapter: a3
        ipv4: "224.1.2.1"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host2
    location: jinqiao
    network: 
      - name: intranet
        adapter: a4
        ipv4: "197.3.2.2"
      - name: extranet
        adapter: a5
        ipv4: "10.112.3.2"
      - name: biznet
        adapter: a6
        ipv4: "224.1.2.2"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host3
    location: jinqiao
    network: 
      - name: intranet
        adapter: a7
        ipv4: "197.3.2.3"
      - name: extranet
        adapter: a8
        ipv4: "10.112.3.3"
      - name: biznet
        adapter: a9
        ipv4: "224.1.2.3"
    user: 
      - name: cfgu
      - name: xwang3
  - hostName: host4
    location: jinqiao
    network: 
      - name: intranet
        adapter: a10
        ipv4: "197.3.2.4"
      - name: extranet
        adapter: a11
        ipv4: "10.112.3.4"
      - name: biznet
        adapter: a12
        ipv4: "224.1.2.4"
    user: 
      - name: cfgu
      - name: xwang3
```

### 构建部署信息deployment.yaml

假设当前需要在两个平台上共部署三种节点类型，分别是：

- MC：部署在DTP平台，共两个集群，每个集群包含两个节点，其中set1的两个节点需要分别部署在host1和host2上，set2上的两个节点需要分别部署在host3和host4上。两个集群的部署路径分别为/User/sseadmin/MC/set1，/User/sseadmin/MC/set2
- CS：部署在DTP平台，共两个集群，每个集群包含1个节点，其中set1的节点部署在host1上，set2的节点部署在host2上。部署路径为/User/sseadmin/CS/set1，/User/sseadmin/CS/set2
- RC：部署在MTP平台，共两个集群，每个集群包含两个节点，其中set1的两个节点需要分别部署在host1和host2上，set2上的两个节点需要分别部署在host3和host4上。两个集群的部署路径分别为/User/sseadmin/RC/set1，/User/sseadmin/RC/set2

按照构建规则，应为MC.set1新建deployment.yaml如下:

```yaml
artifact: 
  url: "127.0.0.1:8080"
  deployPath: "/User/sseadmin/MC/set1"
  configPath: "config"
node:
  - hostName: "host1"
  - hostName: "host2"
```

为MC.set2新建deployment.yaml如下:

```yaml
artifact: 
  url: "127.0.0.1:8080"
  deployPath: "/User/sseadmin/MC/set2"
  configPath: "config"
node:
  - hostName: "host3"
  - hostName: "host4"
```

类似的，建立其他集群的部署信息文件即可，此处不再赘述。

### 新建服务声明文件service.yaml

假设系统的通信状况如下：

- CS：在extranet上，作为发送方，对MC和RC分别建立setTopic类型的组播通道。按照构建规则，其名称分别为DTP.MC和MTP.RC；CS集群不主动订阅；该类型所有集群内通信网络使用intranet

- RC：在extranet上，向外发布名称为risk的bizTopic类型的组播通道；不主动订阅；集群内通信网络使用intranet

- MC：不发布；在extranet上订阅名为risk的bizTopic；集群内通信网络使用intranet

假设CS对DTP.MC发送的组播信息由其中一个engine提出，名称为engine1，而对MTP.RC发送的组播信息则由节点类型提出，则可额外在其service文件夹下新建一个engine1文件夹，为其单独再建立一份service.yaml文件。
按照构建规则，为CS构建服务声明文件service.yaml如下：

```yaml
innerTopicNet: intranet
pubTopic: 
 - netName: extranet
   setTopic: 
    - topicName: MTP.RC
      isRMB: 1
```

为engine1建立的服务声明文件servive.yaml如下：

```yaml
innerTopicNet: intranet
pubTopic: 
 - netName: extranet
   setTopic: 
    - topicName: DTP.MC
      isRMB: 1

```

为MC构建服务声明文件service.yaml如下

```yaml
innerTopicNet: intranet
subTopic: 
 - netName: extranet
   bizTopic: 
    - topicName: risk
      isRMB: 1
```

为RC构建服务声明文件service.yaml如下

```yaml
innerTopicNet: intranet
pubTopic: 
 - netName: extranet
   bizTopic: 
    - topicName: risk
      isRMB: 1
```

### 编写配置模板

假设CS、RC、MC均要用到一份配置模板app_shl.toml，内容如下：

```toml
[Information]
platName="{{.PlatName}}"
nodeType="{{.NodeType}}"
nodeNum={{.NodeNum}}
nodeId={{.NodeId}}
nodeIndex={{.NodeIndex}}
setID={{.SetId}}
setName="{{.SetName}}"
setIndex={{.SetIndex}}
ip="{{GetIpByNet "intranet"}}"
nextTcpPort="{{GetNextTcpPort}}"
```

假设CS下的so1需要用到一份独特的配置，则可以在CS的template文件夹下新建so1文件夹，添加该配置，假设其名称为so1.toml，内容如下：

```toml
[Information]
platName="{{.PlatName}}"
```

假设有如下需求：so1下需要预设一个空文件夹，名称为so1_2empty，且还需要预设一份空文件nilfile.toml，放置在子文件夹so1_1中。

### 构建配置文件包

本示例中，假设将要提交的目标版本号为3.1.0，其中包含一个配置方案scheme1，其下包含平台DTP和MTP。平台DTP下包含节点类型CS和MC，CS包含一个集群set1，MC包含2个集群set1和set2。平台MTP下包含节点类型RC，其下包含两个集群set1和set2。则相应的配置文夹应构建如下。需要注意的是，使用本地模式生成时，配置文件包的同级目录下需要放置基础设施信息文件infrastructure.yaml

```shell
.
├── 3.1.0
│   └── scheme1
│       ├── DTP
│       │   ├── CS
│       │   │   ├── deployment
│       │   │   │   ├── set1
│       │   │   │   │   └── deployment.yaml
│       │   │   │   └── set2
│       │   │   │       └── deployment.yaml
│       │   │   ├── service
│       │   │   │   ├── engine1
│       │   │   │   │   └── service.yaml
│       │   │   │   └── service.yaml
│       │   │   └── template
│       │   │       ├── app_shl.toml
│       │   │       └── so1
│       │   │           ├── so1.toml
│       │   │           ├── so1_1
│       │   │           │   └── nilfile.toml
│       │   │           └── so1_2empty
│       │   └── MC
│       │       ├── deployment
│       │       │   ├── set1
│       │       │   │   └── deployment.yaml
│       │       │   └── set2
│       │       │       └── deployment.yaml
│       │       ├── service
│       │       │   └── service.yaml
│       │       └── template
│       │           └── app_shl.toml
│       └── MTP
│           └── RC
│               ├── deployment
│               │   ├── set1
│               │   │   └── deployment.yaml
│               │   └── set2
│               │       └── deployment.yaml
│               ├── service
│               │   └── service.yaml
│               └── template
│                   └── app_shl.toml
└── infrastructure.yaml
```

### 执行本地生成命令

进入配置中心客户端可执行文件proxctl所在目录，执行以下命令：

```shell
./proxctl get -u username -t config -e 01 -v 3.1.0 -s scheme1 -m local \
-i path/to/3.1.0 -o path/to/output --topicIp 156.10.1.1,156.10.11.2 \
--topicPort 10000,32768 --tcpPort 20000,40000
```

其中-i为当前目录到配置文件包的相对目录，-o为自定义输出目录，--ip、--port、-e等参数均可按照命令提示自行修改

### 获取生成结果

在指定的输出文件夹（假设指定到了resyml），将得到生成结果，即一个结构如下的文件夹：

```shell
resyml
└── 3.1.0_scheme1
    ├── huarui_files
    │   ├── host.cfg
    │   ├── node.cfg
    │   └── route.cfg
    └── origin_res
        ├── DTP
        │   ├── CS
        │   │   ├── set1
        │   │   │   ├── deployment.yaml
        │   │   │   ├── host1_1
        │   │   │   │   ├── app_shl.toml
        │   │   │   │   └── so1
        │   │   │   │       ├── so1.toml
        │   │   │   │       ├── so1_1
        │   │   │   │       │   └── nilfile.toml
        │   │   │   │       └── so1_2empty
        │   │   │   └── topicInfo.json
        │   │   └── set2
        │   │       ├── deployment.yaml
        │   │       ├── host2_2
        │   │       │   ├── app_shl.toml
        │   │       │   └── so1
        │   │       │       ├── so1.toml
        │   │       │       ├── so1_1
        │   │       │       │   └── nilfile.toml
        │   │       │       └── so1_2empty
        │   │       └── topicInfo.json
        │   └── MC
        │       ├── set1
        │       │   ├── deployment.yaml
        │       │   ├── host1_3
        │       │   │   └── app_shl.toml
        │       │   ├── host2_4
        │       │   │   └── app_shl.toml
        │       │   └── topicInfo.json
        │       └── set2
        │           ├── deployment.yaml
        │           ├── host3_5
        │           │   └── app_shl.toml
        │           ├── host4_6
        │           │   └── app_shl.toml
        │           └── topicInfo.json
        ├── MTP
        │   └── RC
        │       ├── set1
        │       │   ├── deployment.yaml
        │       │   ├── host1_7
        │       │   │   └── app_shl.toml
        │       │   ├── host2_8
        │       │   │   └── app_shl.toml
        │       │   └── topicInfo.json
        │       └── set2
        │           ├── deployment.yaml
        │           ├── host3_9
        │           │   └── app_shl.toml
        │           ├── host4_10
        │           │   └── app_shl.toml
        │           └── topicInfo.json
        ├── deployList.yaml
        └── topicList.json
```

### 修改配置中心服务端和配置中心客户端的配置文件

按照实际情况，按照相应的字段含义修改配置中心服务端和客户端的配置文件。在修改前请确保etcd可用。

### 启动配置中心服务端

进入配置中心服务端可执行程序proxima的同级目录，执行如下命令：

```shell
./proxima start
```

### 缓存配置文件包

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl put -u username -i path/to/3.1.0
```

### 提交基础设施信息文件和配置文件包

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl commit -u username -t infra -i path/to/infrastructure.yaml
./proxctl commit -u username -t raw -v 1.2.0
```

username替换为实际的用户名，其中不得包含字符"."和","

v参数表示期望的版本号，可不填，此处假设期望提交的版本号为1.2.0

### 获取生成的配置结果

进入配置中心客户端可执行文件proxctl的同级文件夹，执行以下命令：

```shell
./proxctl get -u username -t config -v 1.2.0 -s scheme1 -e 01 \
-s scheme1 -m remote -o path/to/output/ --topicIp 156.10.1.1,156.10.11.2 \
--topicPort 10000,32768 --tcpPort 20000,40000
```

其中环境号参数-e、ip范围参数--topicIp、端口范围参数--topicPort、--tcpPort均可在限制范围内自行调整。-v参数指定使用哪个版本的数据生成，此处指定刚刚提交的1.2.0版本。

若请求成功，则在-o参数指定的文件夹得到最终生成结果

如需获取其他数据，可更换-t参数，从配置中心服务端获取不同的数据，规则如下：

|        实现功能        | 接口  | Target, -t |
| :--------------------: | :---: | :--------: |
| 获取生成的所有配置文件 |  GET  |  "config"  |
|  获取基础设施信息文件  |  GET  |  "infra"   |
|     获取所有版本号     |  GET  | "version"  |
|      获取原始数据      |  GET  |   "raw"    |
|   获取用户缓存的数据   |  GET  |  "cache"   |
