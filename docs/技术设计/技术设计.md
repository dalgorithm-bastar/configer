- [1. 设计约束与已知限制](#1-设计约束与已知限制)
- [2. 组件视图](#2-组件视图)
  - [2.1. 整体视图](#21-整体视图)
  - [2.2. 逻辑视图](#22-逻辑视图)
- [3. 数据模型](#3-数据模型)
  - [3.1. 层级结构](#31-层级结构)
  - [3.2. ConfigData](#32-configdata)
  - [3.3. Mode](#33-mode)
  - [3.4. ConfigVersion](#34-configversion)
  - [3.5. Environment](#35-environment)
  - [3.6. Node](#36-node)
  - [3.7. AppConfig](#37-appconfig)
  - [3.8. InterfaceConfig](#38-interfaceconfig)
  - [3.9. DeployConfig](#39-deployconfig)
  - [3.10. GetRequest](#310-getrequest)
  - [3.11. GetResponse](#311-getresponse)
  - [3.12. PutRequest](#312-putrequest)
  - [3.13. PutResponse](#313-putresponse)
  - [3.14. DeleteRequest](#314-deleterequest)
  - [3.15. DeleteResponse](#315-deleteresponse)
  - [3.16. CommitRequest](#316-commitrequest)
  - [3.17. CommitResponse](#317-commitresponse)
  - [3.18. ImportRequest](#318-importrequest)
  - [3.19. ImportResponse](#319-importresponse)
  - [3.20. ExportRequest](#320-exportrequest)
  - [3.21. ExportResponse](#321-exportresponse)
- [4. 技术设计](#4-技术设计)
  - [4.1. 配置获取](#41-配置获取)
    - [4.1.1. 流程](#411-流程)
  - [4.2. 配置缓存](#42-配置缓存)
    - [4.2.1. 流程](#421-流程)
  - [4.3. 删除缓存配置](#43-删除缓存配置)
    - [4.3.1. 流程](#431-流程)
  - [4.4. 版本提交](#44-版本提交)
    - [4.4.1. 流程](#441-流程)
- [5. 接口设计](#5-接口设计)
  - [5.1. 获取配置](#51-获取配置)
  - [5.2. 配置缓存](#52-配置缓存)
  - [5.3. 删除配置缓存](#53-删除配置缓存)
  - [5.4. 提交版本](#54-提交版本)
  - [5.5. 导入](#55-导入)
  - [5.6. 导出](#56-导出)

# 1. 设计约束与已知限制

# 2. 组件视图

## 2.1. 整体视图

![alt](svg/配置中心结构设计-总体架构.svg)

配置中心的系统结构如图，具体如下：

1. 配置服务提供配置的读写、版本管理等功能；
2. envoy代理服务在前端和配置服务间对http请求和grpc调用进行相互转化
3. 部署/操作中心通过etcd获取配置信息。

## 2.2. 逻辑视图

# 3. 数据模型

## 3.1. 层级结构

![alt](svg/配置中心结构设计-层级结构.svg)

## 3.2. ConfigData

| 变量  |  类型  |         说明         |
| :---: | :----: | :------------------: |
| modes | Mode[] | 配置数据中的所有模式 |

## 3.3. Mode

|   变量   |      类型       |         说明          |
| :------: | :-------------: | :-------------------: |
| modeName |     string      | 工作模式（测试/正常） |
| cfgVers  | ConfigVersion[] |  该模式中的所有版本   |

## 3.4. ConfigVersion

|  变量   |     类型      |                 说明                 |
| :-----: | :-----------: | :----------------------------------: |
| version |    string     | 配置版本（username表示用户缓存配置） |
|  envs   | Environment[] |          该版本中的所有环境          |

## 3.5. Environment

| 变量  |  类型  |        说明        |
| :---: | :----: | :----------------: |
|  num  | string |       环境号       |
| nodes | Node[] | 该环境中的所有节点 |

## 3.6. Node

|     变量     |      类型       |   说明   |
| :----------: | :-------------: | :------: |
|    nodeId    |     string      | 节点编号 |
|   platform   |     string      |   平台   |
|     type     |     string      |   类型   |
|     part     |     string      |   分区   |
|   appCfgs    |   AppConfig[]   | 应用配置 |
| interfaceCfg | InterfaceConfig | 接口配置 |
|  deployCfg   |  DeployConfig   | 部署配置 |

## 3.7. AppConfig

|  变量   |  类型  |   说明   |
| :-----: | :----: | :------: |
|  name   | string |  配置名  |
| format  | string | 配置格式 |
| content | string | 配置内容 |

## 3.8. InterfaceConfig

|  变量   |  类型  |   说明   |
| :-----: | :----: | :------: |
|  name   | string |  配置名  |
| format  | string | 配置格式 |
| content | string | 配置内容 |

## 3.9. DeployConfig

|   变量   |  类型  |   说明   |
| :------: | :----: | :------: |
|  appVer  | string | 应用版本 |
|   path   | string | 部署目录 |
| hostname | string |  主机名  |
| network  | string |  子网号  |
| usename  | string |  用户名  |

## 3.10. GetRequest

|    变量    |    类型    |                 说明                 |
| :--------: | :--------: | :----------------------------------: |
| configData | ConfigData | 通过构建ConfigData表示需要查询的内容 |

## 3.11. GetResponse

|    变量    |    类型    |   说明   |
| :--------: | :--------: | :------: |
|   result   |   string   | 请求结果 |
| configData | ConfigData | 查询结果 |

## 3.12. PutRequest

|    变量    |    类型    |    说明    |
| :--------: | :--------: | :--------: |
|  username  |   string   |   用户名   |
| configData | ConfigData | 保存的数据 |

## 3.13. PutResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 3.14. DeleteRequest

|    变量    |    类型    |      说明      |
| :--------: | :--------: | :------------: |
|  username  |   string   |     用户名     |
| configData | ConfigData | 需要删除的数据 |

## 3.15. DeleteResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 3.16. CommitRequest

|   变量   |  类型  |    说明    |
| :------: | :----: | :--------: |
| modeName | string | 当前的模式 |
| username | string | 当前的用户 |

## 3.17. CommitResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 3.18. ImportRequest

|    变量    |    类型    | 说明  |
| :--------: | :--------: | :---: |
| configData | ConfigData |       |

## 3.19. ImportResponse

|  变量  |  类型  | 说明  |
| :----: | :----: | :---: |
| result | string |       |

## 3.20. ExportRequest

|    变量    |    类型    |        说明        |
| :--------: | :--------: | :----------------: |
| configData | ConfigData | 表示需要导出的层级 |

## 3.21. ExportResponse

|    变量    |    类型    |     说明     |
| :--------: | :--------: | :----------: |
|   result   |   string   |              |
| configData | ConfigData | 填充后的结果 |

# 4. 技术设计

## 4.1. 配置获取

### 4.1.1. 流程

![alt](svg/配置中心结构设计-配置获取.svg)

## 4.2. 配置缓存

### 4.2.1. 流程

![alt](svg/配置中心结构设计-配置缓存.svg)

## 4.3. 删除缓存配置

### 4.3.1. 流程

![alt](svg/配置中心结构设计-删除缓存配置.svg)

## 4.4. 版本提交

### 4.4.1. 流程

![alt](svg/配置中心结构设计-版本提交.svg)

# 5. 接口设计

## 5.1. 获取配置

| 接口名 |    输入    |    输出     | 说明  |
| :----: | :--------: | :---------: | :---: |
|  Get   | GetRequest | GetResponse |       |

用户构建ConfigData到自己想要查询到那一级。
如，查询Normal模式下的所有ConfigVersion，则请求中的ConfigData结构为：

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[]
    }
  ]
}
```

服务会向下填充一级内容，即回复的ConfigData结构为：

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[
        {
          "version":"v1.00",
          "envs":[]
        },
        {
          "version":"v0.10",
          "envs":[]
        }
      ]
    }
  ]
}

```

## 5.2. 配置缓存

| 接口名 |    输入    |    输出     | 说明  |
| :----: | :--------: | :---------: | :---: |
|  Put   | PutRequest | PutResponse |       |

用户根据想要保存的数据构建ConfigData，如果ConfigVersion.Version与UserName一致，则保存至对应的用户缓存中。如，提供如下的ConfigData，UserName为“test”，则会保存至“test”用户的缓存中。

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[
        {
          "version":"test",
          "envs":[]
        }
      ]
    }
  ]
}
```

## 5.3. 删除配置缓存

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Delete | DeleteRequest | DeleteResponse |       |

用户根据想要删除的数据构建ConfigData，如果ConfigVersion.Version与UserName一致，则删除对应的用户缓存中的数据。如，提供如下的ConfigData，UserName为“test”，则会删除“Normal“模式下“test”用户的所有缓存数据。

``` json
{
  "modes":[
    {
      "ModeName":"Normal",
      "cfgVers":[
        {
          "version":"test",
          "envs":[]
        }
      ]
    }
  ]
}
```

## 5.4. 提交版本

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Commit | CommitRequest | CommitResponse |       |

用户提供需要提交的模式名及用户名，将该模式中相关用户的配置缓存作为新版本提交，并返回提交的版本号

## 5.5. 导入

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Export | ImportRequest | ImportResponse |       |

## 5.6. 导出

| 接口名 |     输入      |      输出      | 说明  |
| :----: | :-----------: | :------------: | :---: |
| Export | ExportRequest | ExportResponse |       |
