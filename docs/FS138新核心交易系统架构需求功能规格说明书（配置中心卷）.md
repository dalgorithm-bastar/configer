<center><font size=7>FS138新核心交易系统架构需求功能规格说明书（配置中心卷）</font></center>

[toc]

# 需求概述

## 总体概述

在过去的交易系统中，与部署和运行相关的配置分散保存在各个应用集群或实例上，在需要变更某些应用的配置时，依赖于该项应用的其他应用将受到影响。受限于原有的配置存储和管理方式，上述受影响的应用往往无法全面和及时地变更自己的配置文件，这样就给交易系统带来了安全隐患，同时也加重了维护人员的负担。此外，在以往的配置管理模式下，对应用集群的开发和调试也较为复杂，手动修改配置项容易出现错误和遗漏，效率低下。

设立配置中心，就是为了解决配置分散保存分散管理所带来的一系列问题。以往的配置服务是面向应用、面向过程的，而配置中心采用面向数据流和面向对象的思想，在设计上，配置中心的特点主要体现在：

- 对核心交易系统各个集群的部署信息、服务信息、配置模板进行集中可靠的存储和管理
- 根据应用集群保存在配置中心的配置模板以及服务信息，动态生成集群中每个节点所需的配置文件
- 预设与部署信息相关的变量，节点可在配置模板中调用和替换
- 支持离线模式，可使用本地配置包进行生成，便于调试和应对紧急情况

## 存储功能

配置中心负责对配置数据进行统一的存储、变更和版本化管理，其中每个版本的配置数据包括：

- 一份基础设施信息文件，例如物理机信息；
- 若干份部署信息，每份包含了某个配置方案下某个集群的部署方案；
- 若干份服务清单，每一份包含了在某个配置方案下某一集群的全部或部分服务信息，同一集群下可根据不同的子项目存在一份或多份；
- 若干个配置模板组，每一组包含某个配置方案下某一集群所需的一组配置模板。

配置中心将对配置模板进行直接存储，而不会解析其中内容，因此对于配置模板的格式没有强制要求。对于部署信息、服务清单和基础设施信息文件，要求使用**yaml格式**。

配置中心将以文件的形式存储配置模板、部署信息文件、服务清单和基础设施信息文件。

## 服务管理与配置获取功能

### 服务管理

用户需要按照配置中心使用手册为每个配置方案提供一组服务清单组。其中每份服务清单包含某个节点类型的通信信息。

在生成配置文件时，配置中心将根据每个集群的服务清单，为其自动生成所需的组播信息文件。

### 配置文件生成-服务端生成或本地临时替换

当请求生成配置文件时，配置中心将根据各个节点类型预设的模板组，以及保存的部署信息、服务清单组和基础设施信息文件，动态生成当前所需的配置文件。在生产环境中，以上配置数据应当在配置中心进行严格的集中式、版本化的管理，仅支持版本化修改。这样做是为了保证生产环境的稳定性和安全性。

在非生产环境下或发生紧急情况时，配置中心允许在本地填充模板。即使用配置中心客户端，完全利用本地配置文件包进行生成。

## 模板替换

配置中心可根据实际需要预设一些节点可能需要用到的值，包括节点Id、节点索引、集群Id、集群索引、集群名称、节点类型名称、平台名称等，用户可在配置模板中使用go template语法调用。具体可参阅配置中心用户手册。

## 对扩展和变更集群的支持

暂不支持

## 扩展组播信息

在输入的配置文件包中，每个节点类型均包含一个用于描述自身发布和订阅的组播的文件，该文件即为服务清单文件。配置中心最终生成配置文件时，将检测该配置方案的所有组播信息，并自动为每个集群生成一份组播信息文件。

## 配置模板默认变量

|   字段    |  类型  |         含义          |    用法示例    |
| :-------: | :----: | :-------------------: | :------------: |
| platName  | string |  node所处的平台名称   | {{.Platform}}  |
| nodeType  | string |   node的节点类型名    | {{.NodeType}}  |
|  nodeId   | uint16 |        nodeId         |  {{.NodeId}}   |
|  nodeNum  | uint16 |   集群中的节点数量    |  {{.NodeNum}}  |
| nodeIndex | uint16 |       nodeIndex       | {{.NodeIndex}} |
|   setId   | uint16 |  node所处set的setId   |   {{.SetId}}   |
| setIndex  | uint16 | node所处set的setIndex | {{.SetIndex}}  |
|  setName  | string |   node所处set的名称   |  {{.SetName}}  |

# 交互方

## 交互方示意图

![alt](images/需规/交互方4.0.svg)

## 交互方介绍

### 配置中心前端

前端包含配置中心客户端命令行工具、配置中心服务端命令行工具、网页端(暂不实现)。对于前端而言，要求能够提供导入和导出配置数据的的选项，能够查询服务信息，能够缓存配置数据，能够进行版本提交。

### 分布式自动化系统

主要包含操控中心。操控中心可以调用配置中心相关接口获取系统配置文件，也可让用户通过操控中心前端执行上传配置文件、删除缓存等操作。

该部分具体交互方式及实现待定。

# 名词解释

|       名词       |                               释义                               |       特殊说明       |
| :--------------: | :--------------------------------------------------------------: | :------------------: |
|     配置数据     | 与配置相关的数据，包括配置模板、服务清单、配置文件中的一项或多项 |                      |
|     配置模板     |               包含固定配置信息以及可替换信息的文件               |                      |
|    配置模板组    |                  以节点类型为单位的一组配置模板                  |                      |
|     配置文件     |                  使用模板生成后的可用的配置文件                  | 文件数量根据语境确定 |
|     服务清单     |   以集群及其子集为单位，包含其发布和订阅的组播的名称的单个文件   |                      |
|     服务信息     |                         服务清单上的信息                         |                      |
| 基础设施信息文件 |                           包含如物理机信息等基础设施信息的文件                           |                      |
|       前端       |              指配置中心前端，包含网页版和命令行工具              |                      |
|      用户名      |                     前端输入的用户的名称                     |                      |
|    自动化系统    |        需要从配置中心拉取配置的自动运行的系统，如操控中心        |                      |
|     应用集群     |           可以使用同一配置模板组生成配置文件的一组节点           |    以逻辑功能划分    |

# 参考文档

无

# 功能需求

## 需求用例图

![alt](images/需规/用例图1.2.svg)

## 导出功能

- 【CGT00001】可导出指定版本的配置文件包，导出结果为一个压缩包（最终以文件夹或文件形式写到本地）。可选择导出的类型为配置文件包、用户缓存的文件（包括配置文件包和基础设施信息文件）、基础设施信息文件、配置文件包版本号

## 缓存配置文件包

- 【CGT00002】将当前上传的配置文件包全量缓存在输入的用户名下。

## 删除缓存配置包

- 【CGT00003】删除输入用户名下缓存的配置文件包

## 版本提交功能

- 【CGT00004】将用户缓存的配置包提交为下一个递增版本或用户指定版本

## 模板替换功能

- 【CGT00005】使用配置中心预设的参数，在配置模板中的指定位置进行替换

处理说明：在配置模板中调用配置中心预设的参数，参数列表如下：

|   字段    |  类型  |         含义          |    用法示例    |
| :-------: | :----: | :-------------------: | :------------: |
| platName  | string |  node所处的平台名称   | {{.Platform}}  |
| nodeType  | string |   node的节点类型名    | {{.NodeType}}  |
|  nodeNum  | uint16 |  set中包含的节点数量  |  {{.NodeNum}}  |
|  nodeId   | uint16 |        nodeId         |  {{.NodeId}}   |
| nodeIndex | uint16 |       nodeIndex       | {{.NodeIndex}} |
|   setId   | uint16 |  node所处set的setId   |   {{.SetId}}   |
| setIndex  | uint16 | node所处set的setIndex | {{.SetIndex}}  |
|  setName  | string |   node所处set的名称   |  {{.SetName}}  |

## 组播信息扩展功能

- 【CGT00006】在配置文件包中定义组播需求，配置中心按照部署信息和组播需求进行扩展

## 部署信息扩展功能

- 【CGT00007】在配置文件包中定义部署需求，配置中心按照部署信息和基础设施信息文件进行扩展

## 版本迭代及用户反馈相关需求

### 一致输入得到一致输出

- 【CGT00008】在多次生成过程中，如果与配置文件生成有关的输入（如配置文件包、ip范围、端口范围等）都一致，则生成的配置文件也应该一致。

### 为每个主机分配tcp端口池

- 【CGT00009】集群内节点通信需要分配listenPort字段，用于tcp通信。配置中心为每台主机分配一个tcp端口池，发挥硬件的最大能力。

### 生成第三方配置文件

- 【CGT00010】生成华锐配置文件

说明：配置中心在输出结果中包含华锐所需的三份配置文件，格式和示例如下：

第一份：host.cfg 格式：主机名|业务网IP|外联网IP（暂时替换为空格或不填） 示例：

```shell
host1|10.112.3.1|
host2|10.112.3.2|
```

第二份：node.cfg 格式：主机名|节点类型名称|分区编号|节点编号 其中分区编号对应现有的setId，节点编号对应现有的nodeId 示例：

```shell
host1|MC|13|235
host2|RC|14|236
```

第三份：route.cfg 格式：1（默认）|发送方节点类型|发送方分区编号|接收方节点类型|接收方分区编号|endpoint|topicId|isRMB，其中IsRMB使用Y/N表示，endpoint为已经使用环境号替换后的结果。示例：

```shell
1|MC|13|RC|14|224.2.2.2:25105|1231|Y
1|RC|14|MC|13|224.2.2.3:25106|1232|N
```

### 使用yaml格式

- 【CGT00011】使用yaml格式作为配置文件包中基础设施信息文件、部署信息文件、服务声明文件的格式

### 保留template文件夹中的权限位

- 【CGT00012】保留template文件夹中各个文件夹、文件的权限，即在生成输出结果时，该文件夹下的同名文件与输入时的权限保持一致

### 保留template文件夹中的空配置文件

- 【CGT00013】当用户在template文件夹中设有空文件时，在输出中保留

### 格式化输出

- 【CGT00014】

说明：输出文件中的topicInfo.json、deployment.json应格式化，便于相关人员查看

### 配置模板新增预设函数

- 【CGT00015】在配置模板中预设两个函数如下：

```go
//根据网络名称获取该节点部署的主机上对应网卡的IP
//输入为网络名称
//输出为IP地址或可能的错误
func GetIpByNet(netName string)(IP string,err error){}

//获取该节点部署的主机上下一个可用的TCP端口
//无输入
//输出为该主机上下一个可用的tcp端口号或可能的错误
func GetNextTcpPort()(port string,err error){}
```

函数用法示例如下： 示例输入文件：

```shell
{{GetIpByNet "biz_net"}}
{{GetNextTcpPort}}
```

填充后的文件：

```shell
"10.112.3.5"
"1025"
```

## 外部交互功能

### 交互接口GetLatestConfigByEnvNum

- 【CGT00016】根据环境号获取最新配置

背景：

一些分布式应用，例如监测中心，需要获取最新的配置文件，以便跟踪交易系统运行状态。

配置中心按照环境号进行部署，假设系统中一共存在三个环境号，分别是“00”，“01”，“02”，则需要启动三个相互独立的配置中心服务端进行管理。

在这种情况下，配置中心需要提供一个接口，以供外部应用根据环境号获取最新的配置文件。

此外，外部应用在调用接口之前需要先建立一张环境号与配置中心服务端监听地址的对应关系表，假设上述三个配置中心服务端监听地址如下：

|   环境号    |  配置中心监听地址  |
| :-------: | :----: |
|00|10.112.1.1:2333|
|01|10.112.1.2:2333|
|02|10.112.1.3:2333|

则外部应用在调用接口前需使用合适的格式建立表格，假设该应用使用yaml格式，则应建立表格文件如下：

```yaml
"userDefinedName":
  - "00":"10.112.1.1:2333"
  - "01":"10.112.1.2:2333"
  - "02":"10.112.1.3:2333"
```

调用接口前，需根据目标环境号查表获取相应配置中心服务端地址

说明：

使外部应用能够获取某一环境号下最新生成的配置文件

函数原型：

```go
//获取某一环境号下最新生成的配置文件
//输入为环境号
//输出为配置文件压缩包，压缩格式为.tar.gz，或可能的错误
func GetLatestConfigByEnvNum(envNum string)(configFile AnyFile,error err){}

//AnyFile结构体，用于文件传输
type AnyFile struct {
    FileName             string
    FileData             []byte
}
```

# 非功能需求

暂无

# *附录一 层级关系

![alt](images/需规/信息层级v3.1.svg)
